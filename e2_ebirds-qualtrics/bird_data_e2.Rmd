---
title: "What Are Birds?"
output: html_document
---

Add libraries!

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning =FALSE)
library(here)
library(tidyverse)
library(kableExtra)

#Custom function for nice tables

kbl_mystyle = function(kable_input){
  kable_styling(kable_input, full_width = TRUE, 
                htmltable_class = "lightable_striped",
                position = "left")
}
  
```

# Format the Data

Load the original data, removing the preview entries and some Qualtrics formatting

```{r load_data}
#Read in original data, with weird qualtrics column names...
birds <- read_csv(paste0(here(), '/e2_ebirds-qualtrics/Ebirds Naming Experiment_June 12, 2022_16.43.csv')) %>%
  tail(-2) %>%
  filter(Status != "Survey Preview") #Immediately drop preview data!!
```

Do several manual steps to make the Qualtrics column names more informative, and save a new file containing the renamed variables (data dictionary.)

```{r make_better_colnames}

#Make a table to hold the list of variable names
birds_dict <- read_csv(paste0(here(), '/e2_ebirds-qualtrics/Ebirds Naming Experiment_February 4, 2022_14.21.csv'), n_max = 2) %>%
  add_rownames() %>%
  mutate(label = case_when(rowname == 1 ~ "question_text",
                           rowname == 2 ~ "qualtrics_string", 
                           TRUE ~ "")) %>%
  select(-rowname)%>%
  pivot_longer(cols = !all_of(c("label")), names_to = c("column_name")) %>%
  pivot_wider(names_from = c("label"), values_from = c("value")) %>%
  mutate(q_id = str_extract(column_name, "Q[0-9]+")) %>%
  mutate(q_id = if_else(is.na(q_id), str_extract(column_name, "^[A-z]+"), q_id)) %>%
  mutate(q_id = if_else(q_id == "Q23", column_name, q_id))%>%
  mutate(bird_id = if_else(q_id == 'Q30', str_extract(question_text, "^[a-z0-9]+"), "")) %>%
  add_rownames() %>%
  mutate(item_id = str_extract(column_name, "^[0-9]+")) %>%
  mutate(item_id = if_else(is.na(item_id), as.character(200 + as.numeric(rowname)), item_id))

birds_dict_1 = birds_dict %>%
  filter(q_id == "Q30") %>% #Slice off the critical questions, which have the bird name strings!
  select(one_of("bird_id", "item_id"))

birds_dict <- birds_dict %>%
  select(-bird_id) %>%
  left_join(birds_dict_1) %>%
  mutate(column_prefix = case_when(q_id == "Q30" ~ "bird_name_guess",
                                   q_id == "Q38" ~ "bird_seen_before",
                                   TRUE ~ q_id)) %>%
  mutate(new_column_name = if_else(is.na(bird_id), column_prefix, paste(column_prefix, bird_id, sep = '.')))%>%
  select(-one_of("rowname", "q_id","item_id","column_prefix")) %>%
  mutate(new_column_name = case_when(new_column_name == "Q21"~ 'generated_bird_list',
                                     new_column_name == "Q22"~ 'neighborhood_type',
                                     new_column_name == "Q24"~ 'comments',
                                     new_column_name == "Q31"~ 'self_rate_bird_knowledge',
                                     new_column_name == "Q32"~ 'state_province',
                                     new_column_name == "Q39"~ 'prolific_id',
                                     new_column_name == "Q40"~ 'attention_paid_to_birds',
                                     new_column_name == "Q41"~ 'country',
                                     TRUE ~ new_column_name))

write_csv(birds_dict, paste0(here(), '/e2_ebirds-qualtrics/e2_data_dictionary.csv'))
```

Make a function for replacing uninformative original names with the better names we just made

```{r renamewith-fun}
#function for replacing bad names with good ones
replace_names = function(mystring){
  myrow = filter(birds_dict, column_name == mystring)
  return(myrow$new_column_name)
}
```

Apply that function to the dataset!

```{r reshape_birds}
birds <- birds %>%
  rename_with(replace_names) 
```
 
# Examine dataset

Start by splitting the participant-level data from the individual answers to bird questions, to make tables easier to look at. 
 
```{r get-participant-birds}
participant_level_birds <- birds %>%
  select(-starts_with("bird_")) %>%
  select(-starts_with("Recipient")) %>%
  select(-starts_with("Location")) %>%
  select(-starts_with("Q23")) %>%
  select(-one_of("StartDate", "EndDate", "IPAddress", "ExternalReference","prolific_id", "UserLanguage","Q16"))

participant_level_birds <- participant_level_birds %>%
  mutate(Progress = as.numeric(Progress))
```

Get some frequency tables to understand details about our participants

```{r freqtable}
participant_level_birds <- participant_level_birds %>%
  mutate(Duration = as.numeric(Duration),
         self_rate_bird_knowledge = as.numeric(self_rate_bird_knowledge),
         attention_paid_to_birds = as.numeric(attention_paid_to_birds),
         attention_paid_to_birds = as.numeric(attention_paid_to_birds))
  

finished <- participant_level_birds %>%
  group_by(Progress) %>%
  summarize(n = n()) %>%
  rename(percentage_finished = Progress)

freq_prog <- participant_level_birds %>%
  group_by(Progress) %>%
  summarize(n = n())

kable(finished) %>% kbl_mystyle()
```


```{r freqtable2}
duration <- participant_level_birds %>%
  mutate(Duration = Duration/60) %>% #Transform to minutes
  summarize(mean = mean(Duration), median = median(Duration), min = min(Duration), max = max(Duration))

kbl(duration, caption = "Time in minutes") %>%
  kbl_mystyle()

freq_dur <- participant_level_birds %>%
  group_by(Duration) %>%
  summarize(n = n())
```

```{r freqtable3}
self_rate <- participant_level_birds %>%
  filter(!is.na(self_rate_bird_knowledge)) %>%
  summarize(mean = mean(self_rate_bird_knowledge), median = median(self_rate_bird_knowledge), min = min(self_rate_bird_knowledge), max = max(self_rate_bird_knowledge))

kbl(self_rate, caption = "How much you know about birds, 0-100") %>%
  kbl_mystyle()

freq_rate <- participant_level_birds %>%
  group_by(self_rate_bird_knowledge) %>%
  summarize(n = n())
```


```{r freqtable4}
neighborhood<- participant_level_birds %>%
  group_by(neighborhood_type) %>%
  summarize(n = n())
```

```{r freqtable5}
country<- participant_level_birds %>%
  group_by(country, state_province) %>%
  summarize(n = n())
```


Option to view the dataset to explore other columns

```{r viewtable}
#View(participant_level_birds)
```

# Reshape data

Take the item-specific data, and reformat to get 1 response per row.  Add some calculations to make sure we don't unintentionally drop/modify data
```{r}
nrow(participant_level_birds)
```

Total participants `r nrow(participant_level_birds)`

```{r}
birds_pre_reshape = birds
birds <- birds_pre_reshape %>%
  pivot_longer(starts_with("bird_"), names_to = "question", values_to = "response") %>%
  separate(question, into = c("question_type","bird_id"), extra = "merge", sep = "\\.") %>%
  select(one_of("ResponseId", "bird_id", "question_type", "response", "neigborhood_type","country","state_province", "self_rate_bird_knowledge","attention_paid_to_birds","comments", "Progress")) 

birds_guessname <- birds %>%
  filter(question_type == "bird_name_guess") 


birds_seenbefore <- birds %>%
  filter(question_type == "bird_seen_before") %>%
  mutate(bird_seen_before = response) %>%
  select(-one_of("question_type", "response"))

birds_responses <- birds_guessname %>%
  left_join(birds_seenbefore) %>%
  mutate(participant_saw_bird = !is.na(response) | !is.na(bird_seen_before))

guesses_per_bird <- birds_responses %>%
  filter(!is.na(response)) %>%
  group_by(bird_id) %>%
  summarize(bird_n_guesses = n())

guesses_per_participant <- birds_responses %>%
  filter(participant_saw_bird) %>%
  mutate(response_given = !is.na(response)) %>%
  group_by(ResponseId) %>%
  summarize(participant_n_seen = n(), participant_n_guesses = sum(response_given)) %>%
  mutate(participant_proportion_named = participant_n_guesses/participant_n_seen)
```

Total participants `r length(unique(birds$ResponseId))` (should see no change)


Remove blank answers where the participant really didn't respond!

```{r}
birds_responses <- birds_responses %>%
  filter(participant_saw_bird)
```


# Drop low-quality data!

Drop participants if:

- Progress listed is less than 72 (72 seems to be anywhere within the long block)
- Duration < 500 (there's a big gap between 300ish (5min) and 500ish; finishing this study in 5min is unreasonable)
- Birds seen < 30 (This participant, if not caught by the above criteria, still didn't see most of the study)

```{r}
participant_level_birds <- participant_level_birds %>%
  left_join(guesses_per_participant) %>%
  filter(Progress > 70) %>%
  filter(Duration > 500) %>%
  filter(participant_n_seen > 30) 

birds_responses <- birds_responses %>%
  filter(ResponseId %in% participant_level_birds$ResponseId)
  
```


# Add correct answers

Use the names & IDs from Ebirds, and make both the real names and the response names easier to match (e.g. "Canada Goose" --> "canadagoose") 

```{r answer_key}
answer_key <- read_csv(paste0(here(), '/data_ebird/selected_ebirds.csv'))

#Make strings matchable, and define 'short' correct as the last word in the bird's name
answer_key <- answer_key %>%
  mutate(normalized_correct = tolower(common_name)) %>%
  mutate(normalized_correct = str_replace_all(normalized_correct, ' ', '')) %>%
  mutate(normalized_correct = str_replace_all(normalized_correct, '-', '')) %>%
  mutate(normalized_short_correct = tolower(str_extract(common_name, '[A-z]+$')))

#Add the family list as a way to check if people guess something in the same family!
answer_key <- answer_key %>%
  mutate(family_list = str_extract(family, "\\(.+\\)")) %>%
  mutate(family_list = tolower(family_list)) %>%
  mutate(family_list = str_remove_all(family_list, " and allies")) %>%
  mutate(family_list = str_replace_all(family_list, " and", ",")) %>%
  mutate(family_list = str_remove_all(family_list, "[ \\(\\)]")) %>%
  mutate(family_list = str_replace_all(family_list, ",,", ",")) %>%
  mutate(family_list = str_remove_all(family_list, ",$"))

#To add - alternate correct, e.g. duck/mallard, seagull/gull
answer_key <- answer_key %>%
  mutate(alternate_short_correct = case_when(normalized_short_correct == 'gull' ~ 'seagull',
                                             normalized_short_correct == 'mallard' ~ 'duck',
                                             normalized_short_correct == 'goldfinch' ~ 'finch',
                                             normalized_short_correct == 'bluejay' ~ 'jay',
                                             normalized_correct == 'bluejay' ~ 'jay',
                                             normalized_correct == 'canadagoose' ~ 'canadiangoose',
                                             TRUE ~ ""))

#normalize response data for matching!
birds_responses <- birds_responses %>%
  mutate(normalized_response = tolower(response)) %>%
  mutate(normalized_response = str_replace_all(normalized_response, regex("\\W+"), "")) %>%
  mutate(normalized_short_response = tolower(str_extract(response, '[A-z]+$')))
```

Merge the tables...
```{r merge_answers}
birds_responses <- birds_responses %>%
  left_join(answer_key, by = c("bird_id" = "species_code")) 
```

... and calculate correctness!

```{r calc_answers}
rightmost_columns = c("bird_id", "response", "normalized_response", "normalized_correct", "exact_correct", "normalized_short_correct", "relaxed_correct" )

birds_responses <- birds_responses %>%
  mutate(exact_correct = normalized_response == normalized_correct) %>%
  mutate(exact_correct = if_else(is.na(exact_correct), FALSE, exact_correct))%>% 
  mutate(relaxed_correct = str_detect(normalized_response, normalized_short_correct))%>% 
  mutate(alternate_correct = str_detect(normalized_response, alternate_short_correct)) %>%
  mutate(relaxed_correct = if_else(is.na(relaxed_correct), FALSE, relaxed_correct))%>% 
  mutate(alternate_correct = if_else(is.na(alternate_correct), FALSE, alternate_correct))%>%
  mutate(relaxed_correct = relaxed_correct | alternate_correct) %>%
  select(-one_of(rightmost_columns), all_of(rightmost_columns ))
```


Look at correct answers for sanity:
```{r}
correct <- birds_responses %>%
  filter(exact_correct)

incorrect <- birds_responses %>%
  filter(!exact_correct)

freq_used <- birds_responses %>%
  group_by(normalized_response) %>%
  summarize(n = n())
```

Look at additional 'relaxed' correct answers:

```{r}
relaxed_correct <- birds_responses %>%
  filter(relaxed_correct & !exact_correct)
```

(Another large category of wrong answers - just picking a different bird's name)


Look at some wrong answers that defy categorization!

```{r check_wrong}
wrong_answers <- birds_responses %>%
  filter(!exact_correct) %>%
  filter(!relaxed_correct) %>%
  filter(!(normalized_response %in% c("","bird","dontknow","idontknow","idk","na","name","notsure","noidea","noclue","unknown","unsure"))) %>%
  filter(!is.na(response)) %>%
  select(one_of("order", "family", "bird_id", "ResponseId", "normalized_correct", "normalized_response", "common_name", "response")) %>%
  arrange(normalized_response)

freq_wrong <- wrong_answers %>%
  group_by(order, family, common_name, bird_id, normalized_response) %>%
  summarize(n = n())

freq_all <- birds_responses %>%
  group_by(order, family, common_name, bird_id, normalized_response, exact_correct, relaxed_correct) %>%
  summarize(n = n())

write_csv(wrong_answers, paste0(here::here(),'/e2_ebirds-qualtrics/wrong_answers.csv'))
write_csv(freq_wrong, paste0(here::here(),'/e2_ebirds-qualtrics/wrong_answers_summarized.csv'))
write_csv(birds_responses, paste0(here::here(),'/e2_ebirds-qualtrics/all_answers_long.csv'))
write_csv(freq_all, paste0(here::here(),'/e2_ebirds-qualtrics/all_answers_summarized.csv'))
```
Reshape data again

```{r}
birds_wide <- birds_responses %>%
  select(one_of("ResponseId", "bird_id", "bird_seen_before", "participant_saw_bird",  "response", "exact_correct")) %>%
  mutate(bird_seen_before = as.character(bird_seen_before),
         participant_saw_bird = as.character(participant_saw_bird),
         exact_correct = as.character(exact_correct)) %>%
  pivot_wider(id_cols = ResponseId,names_from = bird_id, names_glue = "{bird_id}_{.value}", values_from = c(bird_seen_before,participant_saw_bird,response,exact_correct))

birds_wide <- birds_wide %>%
  select(sort(names(birds_wide))) %>%
  select(ResponseId, everything())

birds_all_wide <- participant_level_birds %>%
  left_join(birds_wide)

write_csv(birds_all_wide, paste0(here::here(),'/e2_ebirds-qualtrics/all_answers_wide.csv'))
```

```{r}
coded_answers <- read_csv(paste0(here(), '/e2_ebirds-qualtrics/all_answers_summarized_mod.csv'), guess_max = 10000)

birds_responses_coded <- birds_responses %>%
  left_join(coded_answers)
  
```


# ZZZZZZZZZZZZZZZZZZZZOld code below!


## Results!

First find out our top scorers on both dimensions. Who is really good at guessing bird names, and which birds are easy or hard to identify?

```{r xtabs, include = TRUE}

bool_sum <- function(mybools){
  return(as.numeric(sum(mybools, na.rm = TRUE)))
}

responses <- bird_name_data %>%
  group_by(participant_label) %>%
  summarize(n = n(), correct = bool_sum(is_correct)) %>%
  mutate(percent_correct = correct/n) %>%
  select(participant_label, percent_correct, correct) %>%
  arrange(desc(percent_correct))

kable(head(responses, 10), caption = "Correctest participants", col.names = c('participant id/name', '% accurate', 'n correct answers'))
```

```{r most-known}
birds <- bird_name_data %>%
  group_by(bird) %>%
  summarize(n = n(), correct = bool_sum(is_correct)) %>%
  mutate(percent_correct = correct/n) %>%
  select(bird, percent_correct, correct) %>%
  arrange(desc(percent_correct))

kable(head(birds, 10), caption = "Most known birds", col.names = c('bird name', '% accurate', 'times labeled correctly'))

birds <- arrange(birds, percent_correct, correct)

kable(head(birds, 10), caption = "Least known birds", col.names = c('bird name', '% accurate', 'times labeled correctly'))
```

<br>

Next, let's find out about how confusing birds are! Starting here, we no longer care about exact words, but about
"mistaken identities" - so we'll count calling a goose a "mallard" and a goose a "duck" as the same single confusion, and calling a duck a "mallard" or "duck" as the same kind of correct answer. This requires a bit of data reshaping.

```{r get-category-labels}
bird_name_data <- bird_name_data %>%
  mutate(duck_category = duck | mallard,
         gull_category = gull | herringgull | seagull,
         chicken_category = chicken | rooster,
         finch_category = finch | goldfinch,
         martin_category = martin | purplemartin) %>%
  mutate(correct_entity = case_when(normalized_correct_simple == "duck" ~ "duck_category",
                                    normalized_correct_simple == "gull" ~ "gull_category",
                                    normalized_correct_simple == "chicken" ~ "chicken_category",
                                    normalized_correct_simple == "finch" ~ "finch_category",
                                    normalized_correct_simple == "purplemartin" ~ "martin_category",
                                               TRUE ~ normalized_correct_simple))
```


```{r confuse-who}
confusing <- bird_name_data %>%
  group_by(bird) %>%
  summarize(correct_entity = first(correct_entity),
            across(c("crow", "raven","sparrow","blackbird",
                              "bluebird","bluejay","chickadee","heron","robin","starling",
                              "nuthatch","pigeon", "falcon",
                              "woodpecker","pelican","osprey","stork",
                              "hummingbird","grackle","dove","plover","hawk",
                              "magpie","cardinal","wren","eagle","goose", "owl",
                              "hummingbird", "swan","turkey",
                              "woodcock","waxwing","junco","cormorant","catbird",
                              "flicker","mockingbird",
                              "sandpiper", "warbler","titmouse","vulture", "duck_category", "gull_category", "chicken_category", "finch_category", "martin_category"),
                            bool_sum, .names = "labeled_as_{.col}")) #%>%
  #rowwise() %>%
  #mutate(n_labels_used = sum(c_across(contains('labeled_as')) > 0))
```

We pivot that data to a long-form confusion matrix

```{r confuse-spread}
confusion_mat <- confusing %>%
  pivot_longer(contains('labeled_as'), names_to = c("given_label"), values_to = c("n_used_this_label")) %>%
  mutate(given_label = str_remove(given_label, "labeled_as_")) %>%
   mutate(is_correct_label = given_label == correct_entity)

  # mutate(is_correct_label = case_when(given_label == 'seagull' & correct_label == 'gull' ~ TRUE,
  #                                     given_label == 'herringgull' & correct_label == 'gull' ~ TRUE,
  #                                     given_label == 'mallard' & correct_label == 'duck' ~ TRUE,
  #                                     given_label == 'rooster' & correct_label == 'chicken' ~ TRUE,
  #                                     given_label == 'goldfinch' & correct_label == 'finch' ~ TRUE,
  #                                     given_label == 'purplemartin' & correct_label == 'martin' ~ TRUE,
  #
  #   TRUE ~ is_correct_label)) %>%
  # mutate(given_label = case_when(given_label == 'seagull' & correct_label == 'gull' ~ 'gull',
  #                                     given_label == 'herringgull' & correct_label == 'gull' ~ 'gull',
  #                                     given_label == 'mallard' & correct_label == 'duck' ~ 'duck',
  #                                     given_label == 'rooster' & correct_label == 'chicken' ~ 'chicken',
  #                                     given_label == 'goldfinch' & correct_label == 'finch' ~ 'finch',
  #                                     given_label == 'purplemartin' & correct_label == 'martin' ~ 'martin',
  #
  #   TRUE ~ given_label)) %>%
  # group_by(correct_label, given_label) %>%
  # summarize(bird = first(bird), n_labels_used = first(n_labels_used), n_used_this_label = sum(n_used_this_label), is_correct_label = first(is_correct_label)) %>%
  # ungroup()
```

And check that all items have exactly one 'correct' label entry now, and confirm some troublesome ones.

```{r check-conf}
check_labels <- confusion_mat %>%
  group_by(bird) %>%
  summarize(has_real_label = any(is_correct_label), correct_entity = first(correct_entity), n = n()) %>%
  filter(!has_real_label)

check_labels <- confusion_mat %>%
  filter(n_used_this_label > 0) %>%
  group_by(bird) %>%
  summarize(real_labels = sum(is_correct_label)) %>%
  filter(real_labels > 1)

check_labels <- confusion_mat %>%
  filter(n_used_this_label > 0) %>%
  filter(correct_entity %in% c('duck_category','gull_category'))
```

From this matrix, we can calculate our cool facts about what birds are ACTUALLY named.!

* What birds are actually given their correct name most often? (Same as the correctness count above!)

```{r report-confusion1}
most_correct <- confusion_mat %>%
  arrange(desc(n_used_this_label))%>%
  filter(is_correct_label) %>%
  select(bird, correct_entity, n_used_this_label)

kable(head(most_correct, 10), caption = "Birds identified correctly", col.names = c( 'full and legal bird name', 'label/category', 'times correctly labeled'))
```


<br>
* What birds are most often mis-labeled, with any name? This is *different* from the least-correctly guessed birds, since people who give wrong answers don't always mistake it for another bird.

```{r report-confusion2}
paste_values <- function(mylist){
  mystring = paste(mylist, collapse = ", ")
  return(mystring)
}

most_incorrect <- confusion_mat %>%
  filter(!is_correct_label) %>%
  filter(n_used_this_label > 0) %>%
  ungroup() %>%
  group_by(bird) %>%
  summarize(n_gave_wrong_label = sum(n_used_this_label),
            n_different_wrong_labels = length(unique(given_label)),
            given_labels = toString(given_label))%>%
  arrange(desc(n_gave_wrong_label))

kable(head(most_incorrect, 10), caption = "Birds mistaken for another bird", col.names = c('full and legal bird name', 'number wrong', 'distinct wrong answers', 'list of wrong labels'))
```

<br>
* What birds are most often mis-identified as another SPECIFIC bird?

```{r report-confusion3}
most_incorrect <- confusion_mat %>%
  arrange(desc(n_used_this_label))%>%
  filter(!is_correct_label) %>%
  select(bird, correct_entity, given_label, n_used_this_label)

kable(head(most_incorrect, 10), caption = "Birds mistaken for another bird", col.names = c('full and legal bird name', 'actual label/category', 'guessed label/category', 'times incorrectly labeled'))
```


<br>
* What bird name do people most like to guess across all birds when they don't actually know the answer?

```{r report-confusion4}
most_incorrect <- confusion_mat %>%
  filter(!is_correct_label) %>%
  group_by(given_label) %>%
  summarize(n = sum(n_used_this_label)) %>%
  arrange(desc(n))%>%
  select(given_label, n)

kable(head(most_incorrect, 10), caption = "Frequently incorrect bird labels", col.names = c('guessed label/category', 'times incorrectly used'))
```

<br>
More questions?